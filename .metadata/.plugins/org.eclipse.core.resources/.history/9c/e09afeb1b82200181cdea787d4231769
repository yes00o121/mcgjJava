package com.yc.tieba;

import java.io.ByteArrayOutputStream;
import java.io.DataOutputStream;
import java.io.InputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.swing.JOptionPane;

import com.alibaba.fastjson.JSONObject;
import com.yc.Util;

/**
 * è´´å§å¯¹è±¡
 * @author ad
 *ä¸‹è½½çš„è¿‡ç¨‹ï¼ŒæŒ‡å®šè´´å§åç§°ï¼Œæ‰¾åˆ°è´´å§è¯»å–é»˜è®¤é¡µæ•°ï¼Œå¯¹æ¯ä¸€ä¸ªè´´å­è¿›è¡Œè§£æï¼Œè¿›å…¥æ¥¼å±‚åŒæ—¶è§£æå½“å‰ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¦‚å­˜åœ¨ç»§ç»­è¿›è¡Œæ•°æ®çš„å†™å…¥ï¼Œä¸å­˜åœ¨å°†è¯¥ç”¨æˆ·å…¥åº“ï¼Œé»˜è®¤è¯»å–å®Œæ‰€æœ‰æ¥¼å±‚åç»§ç»­ä¸‹ä¸€ä¸ªè´´å­æŠ“å–
 */
public class Conversation {
	
	private String address = "http://127.0.0.1:8090";//æœ¬åœ°æœåŠ¡å™¨åœ°å€
	
	private String dwImg = "/common/image?imgId=";//ä¸‹è½½å›¾ç‰‡
	
	private String upImg = "/common/uploadFile";//ä¸Šä¼ å›¾ç‰‡
	
	private String tiebaUrl = "https://tieba.baidu.com/f?fr=wwwt&kw=";//è´´å§åœ°å€
	
	private String token = "20d98a33aa5236e2ccf3c35fd2b573fd";
	
//	private String tiebaUrl = "https://tieba.baidu.com/f?ie=utf-8&kw=";
	
//	private String tiebaUrl = "http://tieba.baidu.com/f?fr=wwwt&kw=%E6%96%B0%E5%9E%A3%E7%BB%93%E8%A1%A3&red_tag=h1105420967";//è´´å§åœ°å€
	
	private String tiebaName;//è´´å§åç§°
	
//	private static String HREF_REGULAR = "href=\"(/p.*\")";
//	private static String HREF_REGULAR = "href=\"/p/.*\">";
	private static String HREF_REGULAR = "href=\"/p([\"\']*)([^\"\']*[\"\'])";
	
	private Integer defaultLimit = 2;//é»˜è®¤ä¸‹è½½çš„è´´å­æ•°
	
	public Conversation(){
		
	}
	public Conversation(String tiebaName){
		this.tiebaName = tiebaName;
		this.analysisConversation(tiebaName);//è§£æè´´å§
	}
	/*
	//è¿è¡Œä¸‹è½½è´´å§æ•°æ®
	private void running(){
		
		String url = Util.getHTML(this.tiebaUrl+this.tiebaName+"&pn=0");//è´´å§ä¸»é¡µçš„url
		List<String> analysisUrl = this.analysisUrl(url);//è·å–å½“å‰è´´å§å½“å‰é¡µæ‰€æœ‰çš„url
//		analysisUrl.get(0);
		
		String html = Util.getHTML("https://tieba.baidu.com"+analysisUrl.get(0));
		this.analysisFloorOne(html);
	}
	*/
	//è§£æå½“å‰è´´å§çš„ä¸­æ‰€æœ‰å¸–å­çš„url
	private List<String> analysisUrl(String url){
		try {
			List<String> imgs = new ArrayList<String>();
			Pattern pattern = Pattern.compile(HREF_REGULAR);
//			Pattern patternBase64 = Pattern.compile(IMAGE_REGULAR_BASE64);
			Matcher matcher = pattern.matcher(url);
			while(matcher.find()){
				String a = matcher.group();
				String address = a.split("=\"")[1];
				address = address.substring(0,address.length()-1);//åˆ é™¤æœ€åä¸€ä¸ª"
				imgs.add(address);
//				System.out.println(address);
			}
			return imgs;
//			System.out.println(imgs);
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
	//è§£ææ¥¼å±‚æ•°æ®,æ ‡é¢˜ä¸ºh3
	private List<String> analysisFloorOne(String html){
		
		try {
			String html2 = Util.getHTML(html);
			html2 = html2.trim();
			String h3 = "<h3.*?title=.*?(.*?\">)";
			Pattern pattern = Pattern.compile(h3);
			Matcher matcher = pattern.matcher(html2);
//			System.out.println(html2);
			String title= null;//æ ‡é¢˜
			String content = null;//å†…å®¹
			String conversationName = null;//è´´å§å
			String userName = null;//ç”¨æˆ·å
			String photo = null;//å¤´åƒ
			//è·å–è´´å­æ ‡é¢˜
			if(matcher.find()){
				title = matcher.group().split("title=\"")[1];
				title = title.split("\"")[0];
				System.out.println(title);
				String name = "title=\".*?><è¿”å›";
				Pattern pattern3 = Pattern.compile(name);
				Matcher matcher3 = pattern3.matcher(html2);
				if(matcher3.find()){
					String m3 = matcher3.group();
					String[] strs = m3.split("\"><è¿”å›")[0].split("title=\"");
					conversationName = strs[strs.length-1];
					System.out.println(conversationName);
				}
			}else{
				//æ ‡é¢˜è·å–ä¸åˆ°å¯åŠ¨äºŒå·æ–¹æ¡ˆ
				this.analysisFloorTwo(html2);
				return null;//æ ‡é¢˜è·å–ä¸åˆ°ç›´æ¥é€€å‡º
			}
			System.out.println("æ•°æ®ã€‚ã€‚ã€‚");
			//è·å–ä¸€æ¥¼æ‰€æœ‰çš„å†…å®¹
			String floor = "<div class=\"l_post l_post_bright j_l_post clearfix  \".*?pb_tpoint.*?>";
			Pattern pattern2 = Pattern.compile(floor);
			Matcher matcher2 = pattern2.matcher(html2);
			List<String> list = new ArrayList<String>();
			while(matcher2.find()){
				String a = matcher2.group();
				String[] str = a.split("data-field=\'");
				if(str.length == 2){
					String str2 = str[1].replace("&quot;", "\"").replace("&lt;","<").replace("&gt;",">").replace("â­","").replace("ğŸ™‡","");
					str2 = str2.substring(0,str2.length()-3);
					System.out.println(str2);
					list.add(str2);
				}
			}
			List<String> list2 = new ArrayList<String>();
			List<String> list3 = new ArrayList<String>();
			//è·å–å½“å‰æ¥¼å±‚çš„ç”¨æˆ·åå’Œå¤´åƒ
			String name = "<img username=\".*?/>";
			Pattern pattern3 = Pattern.compile(name);
			Matcher matcher3 = pattern3.matcher(html2);
			System.out.println("+++");
			while(matcher3.find()){
//				System.out.println(matcher3.group());
				String n = matcher3.group();
				String p =null;
				if(n.indexOf("data-tb-lazyload") != -1){
					p= n.split("data-tb-lazyload=\"")[1].split("\"")[0];
				}else{
					p = n.split("src=\"")[1].split("\"")[0];
				}
				n =n.split("username=\"")[1].split("\"")[0];
				list2.add(n);
				list3.add(p);
			}
			String oneFloor = list.get(0).toString();
			userName = list2.get(0).toString();
			photo = list3.get(0).toString();
			System.out.println(userName);
			System.out.println(photo);
			System.out.println("å¼€å§‹è·å–id..........");
			String userId = this.getUserId(userName,this.imgDownload(photo).split("imgId=")[1]);
			JSONObject parseObject = JSONObject.parseObject(oneFloor);
			JSONObject parseObject2 = JSONObject.parseObject(parseObject.get("content").toString());
			content = parseObject2.get("content").toString();
			content = this.contentHandler(content);
//			å¯¹contentå†…å®¹è¿›è¡Œå¤„ç†å°†é‡Œé¢çš„imgæ ‡ç­¾çš„å›¾ç‰‡ä¸‹è½½åˆ°æœ¬åœ°åº“ä¸­è¿›è¡Œæ›¿æ¢
			String childId = this.writeConversationSurface(title, content, conversationName,userId);//è·å–è´´å­id
			System.out.println("è¿›è¡Œæ¥¼å±‚å‘¢æ“ä½œäº†ã€‚ã€‚ã€‚ã€‚ã€‚");
			for(int i=1;i<list2.size();i++){
				JSONObject parseObject3 = JSONObject.parseObject(list.get(i));
				JSONObject parseObject4 = JSONObject.parseObject(parseObject3.get("content").toString());
				content = parseObject4.get("content").toString();
				content = this.contentHandler(content);
				System.out.println("æ¥¼å±‚æ“ä½œã€‚ã€‚ã€‚");
				System.out.println(list3.get(i));
				String imgId = this.imgDownload(list3.get(i));
				String id = this.getUserId(list2.get(i),imgId.split("imgId=")[1]);
				this.writeFloor(childId, content, id,userId);
			}
			//è·å–çš„å½“å‰è´´å­çš„é¡µæ•°
			String total = "å…±<span.*?</span>é¡µ";
			Pattern pattern4 = Pattern.compile(total);
			Matcher matcher4 = pattern4.matcher(html2);
			int number = 0;//è´´å­æ€»é¡µæ•°
			if(matcher4.find()){
				String group = matcher4.group();
				String[] split = group.split("\">")[1].split("</span");
				number = Integer.parseInt(split[0]);
			}
			System.out.println("æ€»é¡µæ•°ä¸ºã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚"+number);
			System.out.println("++++++++++++++++++++++++++++++++++++++++++++++++++++");
			return null;
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
	//å†™è´´å­æ¥¼å±‚æ•°æ®
	private void writeFloor(String childId,String content,String userId,String userId2){
		try {
			URL url = new URL(this.address+"/spider/addFloorDataSpider");
			URLConnection openConnection = url.openConnection();
			HttpURLConnection httpConn = (HttpURLConnection)openConnection;
			httpConn.setDoOutput(true);   //éœ€è¦è¾“å‡º
		    httpConn.setDoInput(true);   //éœ€è¦è¾“å…¥
		    httpConn.setUseCaches(false);  //ä¸å…è®¸ç¼“å­˜
		    httpConn.setRequestMethod("POST");   //è®¾ç½®POSTæ–¹å¼è¿æ¥
		    //è®¾ç½®è¯·æ±‚å±æ€§
		    httpConn.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
		    httpConn.setRequestProperty("Connection", "Keep-Alive");// ç»´æŒé•¿è¿æ¥
		    httpConn.setRequestProperty("Charset", "UTF-8");
		    //å»ºç«‹è¾“å…¥æµï¼Œå‘æŒ‡å‘çš„URLä¼ å…¥å‚æ•°
		    DataOutputStream dos=new DataOutputStream(httpConn.getOutputStream());
		    dos.writeBytes("conversationChildId="+childId+"&userId="+Integer.parseInt(userId)+"&content="+URLEncoder.encode(content,"utf-8")+"&userId2="+Integer.parseInt(userId2)+"&token="+token+"");
		    dos.flush();
		    dos.close();
		    httpConn.getInputStream();
		} catch (Exception e) {
			e.printStackTrace();
		}
//		addFloorDataSpider
	}
	private String getUserId(String userName,String photo){
		ByteArrayOutputStream baos = null;
		InputStream is = null;
		try {
			URL url  = new URL(this.address+"/user/selectIsExists?userName="+URLEncoder.encode(userName,"utf-8")+"&photo="+photo);
			URLConnection openConnection = url.openConnection();
			HttpURLConnection httpURLConnection = (HttpURLConnection)openConnection;
			if(httpURLConnection.getResponseCode() != 200)
				throw new RuntimeException("è·å–ç”¨æˆ·å¤±è´¥");
			is = httpURLConnection.getInputStream();
			baos = new ByteArrayOutputStream();
			int read = 0;
			byte[] bts = new byte[1024];
			while((read= is.read(bts)) != -1){
				baos.write(bts,0,read);
			}
			String id = new String(baos.toByteArray());
			return id;
		} catch (Exception e) {
			e.printStackTrace();
		}finally{
			try {
				if(baos!= null)
					baos.close();
				if(is != null)
					is.close();
			} catch (Exception e2) {
				e2.printStackTrace();
			}
		}
		return "1";
	}
	//ç™¾åº¦è´´å§ä¸åŒçš„é¡µé¢ï¼Œæ ‡é¢˜ä¸ºh1
	private List<String> analysisFloorTwo(String html){
		try {
			String title = "";//æ ‡é¢˜
			String content = "";//å†…å®¹
			String conversationName = "";//è´´å§åç§°
			String h1 = "<h1.*?title.*?>";
			Pattern pattern = Pattern.compile(h1);
			Matcher matcher = pattern.matcher(html);
			if(matcher.find()){
				title = matcher.group();
				title = title.split("title=\"")[1].split("\"")[0];
				System.out.println("æ ‡é¢˜ä¸ºã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚"+title);
			}else{
				//æ‰¾ä¸åˆ°h1çš„æ ‡é¢˜
			}
			List<String> floors = new ArrayList<String>();//æ¥¼å±‚å†…å®¹
			String cc = "<cc.*?</cc>";
			Pattern pattern2 = Pattern.compile(cc);
			Matcher matcher2 = pattern2.matcher(html);
			while(matcher2.find()){
				String str = matcher2.group();
				str = str.split("clearfix\">")[1].trim().split("</div><br></cc>")[0].replace("â­","").replace("ğŸ™‡","");
//				System.out.println(str);
				floors.add(str);
			}
			//è·å–æ¥¼ä¸»çš„å‘è¨€
			String floor = floors.get(0);
			System.out.println(floor);
//			System.out.println(floor.replace("ğŸ™‡",""));
			content = this.contentHandler(floor);
			System.out.println(content);
			//è·å–è´´å§åç§°
			String name = "fname=.*?<title>";
			Pattern pattern3 = Pattern.compile(name);
			Matcher matcher3 = pattern3.matcher(html);
			if(matcher3.find()){
				conversationName = matcher3.group().replace("â­","").replace("ğŸ™‡","").split("\"><meta")[0].split("\"")[1].replace("&amp;","").replace("&lt;","<").replace("&gt;",">").trim();
				System.out.println(conversationName);
			}
			
			List<String> list2 = new ArrayList<String>();
			List<String> list3 = new ArrayList<String>();
			//è·å–å½“å‰æ¥¼å±‚çš„ç”¨æˆ·åå’Œå¤´åƒ
			String name1 = "<img username=\".*?/>";
			Pattern pattern4 = Pattern.compile(name1);
			Matcher matcher4 = pattern4.matcher(html);
			while(matcher4.find()){
//				System.out.println(matcher3.group());
				String n = matcher4.group();
				String p =null;
				if(n.indexOf("data-tb-lazyload") != -1){
					p= n.split("data-tb-lazyload=\"")[1].split("\"")[0];
				}else{
					p = n.split("src=\"")[1].split("\"")[0];
				}
				n =n.split("username=\"")[1].split("\"")[0];
				list2.add(n);
				list3.add(p);
			}
			String userName = list2.get(0);
			String photo = list3.get(0);
			String userId = this.getUserId(userName,this.imgDownload(photo).split("imgId=")[1]);
			//å¯¹contentå†…å®¹è¿›è¡Œå¤„ç†å°†é‡Œé¢çš„imgæ ‡ç­¾çš„å›¾ç‰‡ä¸‹è½½åˆ°æœ¬åœ°åº“ä¸­è¿›è¡Œæ›¿æ¢
			String childId = this.writeConversationSurface(title, content, conversationName,userId);
			for(int i=1;i<list2.size();i++){
				System.out.println("!!!!-----------");
				System.out.println(list2.get(i));
				System.out.println(list3.get(i));
				String imgId = this.imgDownload(list3.get(i));//ä¸‹è½½å›¾ç‰‡
//				System.out.println("æ¥¼å±‚æ“ä½œã€‚ã€‚ã€‚");
				String id = this.getUserId(list2.get(i), imgId.split("imgId=")[1]);
				String con = floors.get(i);
				con = this.contentHandler(con);//å¤„ç†æ¥¼å±‚å†…å®¹
				this.writeFloor(childId, con, id,userId);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}
	//å†…å®¹å¤„ç†
	private String contentHandler(String content){
		try {
			String img = "<img.*?(.*?>)";
			System.out.println(content);
			Pattern compile = Pattern.compile(img);
			Matcher matcher = compile.matcher(content);
			while(matcher.find()){
//				System.out.println(matcher.group());
				String str  = matcher.group();
				String str2 = str.split("src=\"")[1].split("\"")[0];
				if(str2.indexOf("https://gsp0.baidu.com") == -1 && str2.indexOf("static.tieba.baidu.com") == -1 && str2.indexOf("tb2.bdstatic") == -1 && str2.indexOf("height=\"20\"")== -1){
					System.out.println(str2);
					System.out.println("!!!!!!!!!!!!!!!!!!!!!!@@@@@");
					String imgId = imgDownload(str2);//ä¸‹è½½å›¾ç‰‡
					System.out.println(imgId);
					//æ›¿æ¢å½“å‰contentä¸­çš„å›¾ç‰‡
					content = content.replace(str,"<img src=\""+this.address+imgId.trim()+"\">");
				}else{
					System.out.println("ä¸å­˜åœ¨ã€‚ã€‚ã€‚ã€‚");
					System.out.println(str2);
					//æ›¿æ¢å½“å‰contentä¸­çš„å›¾ç‰‡
					content = content.replace(str,"");//å¦‚æœå›¾ç‰‡ä¸å­˜åœ¨æ¸…ç©ºå›¾ç‰‡
				}
			}
			System.out.println(content);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return content;
	}
	private String imgDownload(String img){
		ByteArrayOutputStream baos = null;
		InputStream is3 = null;
		try {
			//å…ˆå°†ç™¾åº¦çš„å›¾ç‰‡ä¸‹è½½ä¸‹æ¥
			URL url2 = new URL(img);
			URLConnection openConnection = url2.openConnection();
			HttpURLConnection httpURLConnection = (HttpURLConnection)openConnection;
	        InputStream is = httpURLConnection.getInputStream();
	        String end = "\r\n";
	        String twoHyphens = "--";
	        String boundary = "*****";
	        String newName = "image.jpg";
	        URL url3 = new URL(this.address+this.upImg);
			URLConnection openConnection3 = url3.openConnection();
			HttpURLConnection httpURLConnection3 = (HttpURLConnection)openConnection3;
			httpURLConnection3.setDoInput(true);  
	        httpURLConnection3.setDoOutput(true);  
	        httpURLConnection3.setUseCaches(false);  
	        /* è®¾ç½®ä¼ é€çš„method=POST */
	        httpURLConnection3.setRequestMethod("POST");
	        /* setRequestProperty */
	        httpURLConnection3.setRequestProperty("Connection", "Keep-Alive");
	        httpURLConnection3.setRequestProperty("Charset", "UTF-8");
	        httpURLConnection3.setRequestProperty("Content-Type", "multipart/form-data;boundary=" + "*****");
	        /* è®¾ç½®DataOutputStream */
	        DataOutputStream ds = new DataOutputStream(httpURLConnection3.getOutputStream());
	        ds.writeBytes(twoHyphens + boundary + end);
	        ds.writeBytes("Content-Disposition: form-data; "+ "name=\"file\";filename=\"" + newName + "\"" + end);
	        ds.writeBytes(end);
	        baos = new ByteArrayOutputStream();
	        int read = 0;
	        byte[] bts = new byte[1024];
	        while((read = is.read(bts)) != -1){
	        	baos.write(bts,0,read);
	        }
	        ds.write(baos.toByteArray());
	        ds.writeBytes(end);
	        ds.writeBytes(twoHyphens + boundary + twoHyphens + end);  
	        ds.flush();
	        ds.close();
	        is3 = httpURLConnection3.getInputStream();
	        ByteArrayOutputStream baos2 = new ByteArrayOutputStream();
	        int read3 =0;
	        byte[] bts3 = new byte[1024];
	        while((read3 = is3.read(bts3)) != -1){
	        	baos2.write(bts3);
	        }
	        String imgId = new String(baos2.toByteArray());
	        baos2.close();
	        return imgId;//å›¾ç‰‡id
		} catch (Exception e) {
			e.printStackTrace();
		}finally{
			try {
				if(baos != null)
					baos.close();
				if(is3 != null)
					is3.close();
			} catch (Exception e2) {
				e2.printStackTrace();
			}
				
		}
		
		return null;
	}
	private String writeConversationSurface(String title,String content,String conversationName,String userId){
		System.out.println(title);
		System.out.println(content);
		System.out.println(conversationName);
		ByteArrayOutputStream btas = null;
		ByteArrayOutputStream btas2 = null;
		InputStream is= null;
		InputStream is2 = null;
		//æ ¹æ®è´´å§åæŸ¥è¯¢è´´å§ç›¸å…³æ•°æ®
		try {
//			System.out.println(new String(conversationName.getBytes(),"utf-8"));
			URL url = new URL(this.address+"/conversation/selectConversationByName?conversationName="+URLEncoder.encode(conversationName,"utf-8"));
			URLConnection openConnection = url.openConnection();
			HttpURLConnection huc = (HttpURLConnection)openConnection;
			is = huc.getInputStream();
			int read = 0;
			byte[] buff = new byte[1024];
			btas = new ByteArrayOutputStream();
			while((read = is.read(buff)) != -1){
				btas.write(buff,0,read);
			}
			String str = new String(btas.toByteArray(),"utf-8");
			System.out.println(str);
			JSONObject parseObject = JSONObject.parseObject(str);
			Object conversationName2 = parseObject.get("result");
			if(conversationName2 == null){
				JOptionPane.showMessageDialog(null,"ç³»ç»Ÿæ²¡åˆ›å»ºè¯¥è´´å§","æç¤º",JOptionPane.ERROR_MESSAGE);
				Main.BtnActive();
				return null;
			}
				
			JSONObject parseObject2 = JSONObject.parseObject(conversationName2.toString());
			String id = parseObject2.get("id").toString();
			System.out.println(id);
			//æ•°æ®æ’å…¥åº“é‡Œï¼Œé»˜è®¤ç”¨æˆ·idä¸º14
			URL url2 = new URL(this.address+"/conversationChild/addConversationChild");
			URLConnection openConnection2 = url2.openConnection();
			HttpURLConnection httpConn = (HttpURLConnection)openConnection2;
			httpConn.setDoOutput(true);   //éœ€è¦è¾“å‡º
		    httpConn.setDoInput(true);   //éœ€è¦è¾“å…¥
		    httpConn.setUseCaches(false);  //ä¸å…è®¸ç¼“å­˜
		    httpConn.setRequestMethod("POST");   //è®¾ç½®POSTæ–¹å¼è¿æ¥
		    //è®¾ç½®è¯·æ±‚å±æ€§
		    httpConn.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
		    httpConn.setRequestProperty("Connection", "Keep-Alive");// ç»´æŒé•¿è¿æ¥
		    httpConn.setRequestProperty("Charset", "UTF-8");
		    //å»ºç«‹è¾“å…¥æµï¼Œå‘æŒ‡å‘çš„URLä¼ å…¥å‚æ•°
		    DataOutputStream dos=new DataOutputStream(httpConn.getOutputStream());
		    dos.writeBytes("conversationId="+id+"&userId="+Integer.parseInt(userId)+"&content="+URLEncoder.encode(content,"utf-8")+"&title="+URLEncoder.encode(title,"utf-8")+"&token="+token+"");
		    dos.flush();
		    dos.close();
			if(httpConn.getResponseCode() == 200)
				System.out.println("æ•°æ®æ’å…¥æˆåŠŸã€‚ã€‚ã€‚");
			is2 = httpConn.getInputStream();//è·å–è¿”å›çš„æ•°æ®æµ
			int read2 = 0;
			byte[] bts = new byte[1024];
			btas2 = new ByteArrayOutputStream();
			while((read2 = is2.read(bts)) != -1){
				btas2.write(bts,0,read2);
			}
			String json = new String(btas2.toByteArray());
			Object childId = JSONObject.parseObject(json).get("result");
			return childId.toString();
		} catch (Exception e) {
			e.printStackTrace();
		}finally{
			try {
				if(btas != null)
					btas.close();
				if(is != null)
					is.close();
				if(is2 != null)
					is2.close();
			} catch (Exception e2) {
				e2.printStackTrace();
			}
		}
		return null;
	}
	/**
	 * è§£æè´´å§
	 * @param conversationNameè´´å§å
	 */
	public void  analysisConversation(String conversationName){
		try {
			if(!this.isConversationExists(conversationName)){
				JOptionPane.showMessageDialog(null,"è´´å§ä¸å­˜åœ¨ï¼Œæ— æ³•çˆ¬å–æ•°æ®","æç¤º",JOptionPane.ERROR_MESSAGE);
				Main.BtnActive();
				return;
			}
			Main.center_text.append("å¼€å§‹ä¸‹è½½...\n");
			Main.center_text.setSelectionStart(Main.center_text.getText().length());
			System.out.println("---------------------------------------------------------");
			int pn = 0;
			for(int i=0;i<defaultLimit;i++){
				String html = Util.getHTML(this.tiebaUrl+URLEncoder.encode(conversationName)+"&pn="+pn);//å½“å‰è´´å§çš„é¡µé¢
				List<String> list = analysisUrl(html);//å­˜æ”¾å½“å‰é¡µçš„æ‰€æœ‰è´´å­è·¯å¾„
				for(String l:list){
					System.out.println(l);
//					analysisFloorOne("https://tieba.baidu.com"+l);
				}
				pn+=50;
			}
			Main.center_text.append("ä¸‹è½½å®Œæ¯•...\n");
			Main.center_text.setSelectionStart(Main.center_text.getText().length());
			Main.BtnActive();
		} catch (Exception e) {
			e.printStackTrace();
			JOptionPane.showMessageDialog(null,"è´´å§æ•°æ®çˆ¬å–å¤±è´¥ï¼Œè¯·é‡è¯•","æç¤º",JOptionPane.ERROR_MESSAGE);
			Main.BtnActive();
			return;
		}
	}
	//åˆ¤æ–­è´´å§æ˜¯å¦å­˜åœ¨
	private Boolean isConversationExists(String conversationName){
		try {
//			/conversation/selectConversationByName
			URL url2 = new URL(this.address+"/conversation/selectConversationByName?conversationName="+URLEncoder.encode(new String(conversationName.getBytes("utf-8"))));
			URLConnection openConnection2 = url2.openConnection();
			HttpURLConnection httpConn = (HttpURLConnection)openConnection2;
			InputStream is = httpConn.getInputStream();
			ByteArrayOutputStream baos = new ByteArrayOutputStream();
			int read = 0;
			byte[] bts = new byte[1024];
			while((read = is.read(bts)) != -1){
				baos.write(bts,0,read);
			}
			String json = new String(baos.toByteArray());
			JSONObject parseObject = JSONObject.parseObject(json);
			Object result = parseObject.get("result");
			if(result != null){
				return true;
			}
			return false;
		} catch (Exception e) {
			e.printStackTrace();
			return false;
		}
	}
	public static void main(String[] args) {
		Conversation c = new Conversation();
//		List<String> analysisFloor = c.analysisFloorOne("https://tieba.baidu.com/p/5578793300");
//		List<String> analysisFloor = c.analysisFloorOne("https://tieba.baidu.com/p/4426151897");
		List<String> analysisFloor = c.analysisFloorOne("https://tieba.baidu.com/p/4127539846");//é—®é“
//		List<String> analysisFloor = c.analysisFloorOne("http://tieba.baidu.com/p/5582482142");//æ–°å£ç»“è¡£
//		List<String> analysisFloor = c.analysisFloorOne("https://tieba.baidu.com/p/5577663709");//æµ·è´¼ç‹
//		List<String> analysisFloor = c.analysisFloorOne("http://tieba.baidu.com/p/5579860790");//æ¸¡è¾¹éº»å‹
//		List<String> analysisFloor = c.analysisFloorOne("http://tieba.baidu.com/p/5581288677");//å¤å¤©ä¹
//		c.analysisConversation("è¶³çƒ1");
	}
}
